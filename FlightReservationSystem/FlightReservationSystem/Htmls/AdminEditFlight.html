<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Edit Flight</title>
</head>
<body>
    <h1>Edit Flight</h1>
    <form id="editFlightForm">
        <input type="hidden" id="flightId" />
        <label for="airlineSelect">Select Airline:</label>
        <select id="airlineSelect"></select><br><br>
        <label for="departureInput">Departure:</label>
        <input type="text" id="departureInput" readonly><br><br>
        <label for="destinationInput">Destination:</label>
        <input type="text" id="destinationInput" readonly><br><br>
        <label for="dateOfDepartureInput">Date of Departure:</label>
        <input type="datetime-local" id="dateOfDepartureInput" required><br><br>
        <label for="dateOfDestinationInput">Date of Destination:</label>
        <input type="datetime-local" id="dateOfDestinationInput" required><br><br>
        <label for="priceInput">Price:</label>
        <input type="number" id="priceInput" min="1" step="any" required><br><br>
        <label for="totalSeatsInput">Number of seats:</label>
        <input type="number" id="totalSeatsInput" min="1" readonly><br><br>
        <label for="occupiedSeatsInput">Occupied seats:</label>
        <input type="number" id="occupiedSeatsInput" min="0" readonly><br><br>
        <label for="flightStatusSelect">Flight Status:</label>
        <select id="flightStatusSelect">
            <option value="Active">Active</option>
            <option value="Inactive">Inactive</option>
        </select><br><br>
        <button type="submit">Update Flight</button>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const flightId = urlParams.get('id');
            if (flightId) {
                fetchFlightDetails(flightId);
                fetchAirlines();
            } else {
                alert('Flight ID is missing');
            }
        });

        function fetchFlightDetails(id) {
            fetch(`/api/flights/${id}`)
                .then(response => response.json())
                .then(flight => {
                    document.getElementById('flightId').value = flight.Id;
                    document.getElementById('airlineSelect').value = flight.Airline;
                    document.getElementById('departureInput').value = flight.Departure;
                    document.getElementById('destinationInput').value = flight.Destination;
                    document.getElementById('dateOfDepartureInput').value = flight.DateOfDeparture;
                    document.getElementById('dateOfDestinationInput').value = flight.DateOfDestination;
                    document.getElementById('priceInput').value = flight.Price;
                    document.getElementById('totalSeatsInput').value = flight.AvailableSeats;
                    document.getElementById('occupiedSeatsInput').value = flight.OccupiedSeats;
                    document.getElementById('flightStatusSelect').value = flight.FlightStatus;
                })
                .catch(error => console.error('Error fetching flight details:', error));
        }

        function fetchAirlines() {
            fetch('/api/airlines')
                .then(response => response.json())
                .then(data => {
                    const airlineSelect = document.getElementById('airlineSelect');
                    data.forEach(airline => {
                        const option = document.createElement('option');
                        option.value = airline.Id;
                        option.textContent = airline.Name;
                        airlineSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching airlines:', error));
        }

        document.getElementById('editFlightForm').addEventListener('submit', function (event) {
            event.preventDefault();

            const flightId = document.getElementById('flightId').value;
            const priceInput = document.getElementById('priceInput');
            const price = parseFloat(priceInput.value);

            fetch('/api/reservations')
                .then(response => response.json())
                .then(reservations => {
                    const hasActiveReservations = reservations.some(reservation =>
                        reservation.Flight.Id === parseInt(flightId) &&
                        (reservation.ReservationStatus === 'Created' || reservation.ReservationStatus === 'Approved')
                    );

                    if (hasActiveReservations && price !== parseFloat(priceInput.defaultValue)) {
                        alert('Cannot change the price as there are active reservations.');
                        return;
                    }

                    const updatedFlight = {
                        Airline: document.getElementById('airlineSelect').value,
                        DateOfDeparture: document.getElementById('dateOfDepartureInput').value,
                        DateOfDestination: document.getElementById('dateOfDestinationInput').value,
                        Price: price,
                        FlightStatus: document.getElementById('flightStatusSelect').value
                    };

                    fetch(`/api/flights/${flightId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updatedFlight)
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to update flight. Server responded with ' + response.status);
                            }
                            alert('Flight updated successfully!');
                            window.location.href = '/AdminFlights.html';
                        })
                        .catch(error => {
                            console.error('Error updating flight:', error);
                            alert('Failed to update flight. Please check console for details.');
                        });
                })
                .catch(error => {
                    console.error('Error fetching reservations:', error);
                    alert('Failed to check reservations. Please check console for details.');
                });
        });
    </script>
</body>
</html>
