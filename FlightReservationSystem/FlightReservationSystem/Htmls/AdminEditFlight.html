<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Edit Flight</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>

        .content {
            padding-top: 60px;
        }

        form {
            max-width: 400px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border: 1px solid #ddd;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }

            form label {
                display: block;
                margin-bottom: 8px;
            }

            form input[type="text"],
            form input[type="password"],
            form input[type="email"],
            form input[type="date"] {
                width: calc(100% - 20px);
                padding: 8px;
                margin-bottom: 15px;
                border: 1px solid #ccc;
                border-radius: 4px;
                font-size: 14px;
            }

            form select {
                width: calc(100% - 20px);
                padding: 8px;
                margin-bottom: 15px;
                border: 1px solid #ccc;
                border-radius: 4px;
                font-size: 14px;
            }


        p {
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="navbar"></div>
    <div class="content">

        <form id="editFlightForm">
            <h1>Edit Flight</h1>
            <input type="hidden" id="flightId" />
            <label for="airlineSelect">Select Airline:</label>
            <select id="airlineSelect"></select><br><br>
            <label>Departure:</label>
            <span id="departureText"></span><br><br>
            <label>Destination:</label>
            <span id="destinationText"></span><br><br>
            <label for="dateOfDepartureInput">Date of Departure:</label>
            <input type="datetime-local" id="dateOfDepartureInput" required><br><br>
            <label for="dateOfDestinationInput">Date of Destination:</label>
            <input type="datetime-local" id="dateOfDestinationInput" required><br><br>
            <label for="priceInput">Price:</label>
            <input type="number" id="priceInput" min="1" step="any" required><br><br>
            <label for="totalSeatsInput">Number of seats:</label>
            <input type="number" id="totalSeatsInput" min="1" readonly><br><br>
            <label for="occupiedSeatsInput">Occupied seats:</label>
            <input type="number" id="occupiedSeatsInput" min="0" readonly><br><br>
            <label for="flightStatusSelect">Flight Status:</label>
            <select id="flightStatusSelect">
                <option value="Active">Active</option>
                <option value="Cancelled">Cancelled</option>
                <option value="Completed">Completed</option>
            </select><br><br>
            <button type="submit">Update Flight</button>
        </form>
    </div>
    <script>
        $(document).ready(function () {
            $('#navbar').load('navbar.html');

            const urlParams = new URLSearchParams(window.location.search);
            const flightId = urlParams.get('Id');

            if (flightId) {
                fetchFlightDetails(flightId);
                fetchAirlines();
            } else {
                alert('Flight ID is missing');
            }
        });

        function fetchFlightDetails(id) {
            $.ajax({
                url: `/api/flights/${id}`,
                method: 'GET',
                success: function (flight) {
                    $('#flightId').val(flight.Id);
                    $('#airlineSelect option').filter(function () {
                        return $(this).text() === flight.Airline;
                    }).prop('selected', true);
                    $('#departureText').text(flight.Departure);
                    $('#destinationText').text(flight.Destination);
                    $('#dateOfDepartureInput').val(flight.DateOfDeparture);
                    $('#dateOfDestinationInput').val(flight.DateOfDestination);
                    $('#priceInput').val(flight.Price);
                    $('#totalSeatsInput').val(flight.AvailableSeats);
                    $('#occupiedSeatsInput').val(flight.OccupiedSeats);
                    $('#flightStatusSelect').val(flight.FlightStatus);

                    checkActiveReservations(flight.Id);
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching flight details:', error);
                    alert('Failed to fetch flight details. Please check console for details.');
                }
            });
        }

        function fetchAirlines() {
            $.ajax({
                url: '/api/airlines',
                method: 'GET',
                success: function (data) {
                    const airlineSelect = $('#airlineSelect');
                    airlineSelect.empty();
                    data.forEach(function (airline) {
                        airlineSelect.append(`<option value="${airline.Id}">${airline.Name}</option>`);
                    });
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching airlines:', error);
                    alert('Failed to fetch airlines. Please check console for details.');
                }
            });
        }

        function checkActiveReservations(flightId) {
            $.ajax({
                url: `/api/flights/${flightId}/activeReservations`,
                method: 'GET',
                success: function (hasActiveReservations) {
                    if (hasActiveReservations) {
                        $('#priceInput').prop('readonly', true);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error checking active reservations:', error);
                }
            });
        }

        $('#editFlightForm').submit(function (event) {
            event.preventDefault();

            const flightId = $('#flightId').val();
            const price = $('#priceInput').val();

            const updatedFlight = {
                Airline: $('#airlineSelect').find(':selected').text(),
                Departure: $('#departureText').text(),
                Destination: $('#destinationText').text(),
                DateOfDeparture: $('#dateOfDepartureInput').val(),
                DateOfDestination: $('#dateOfDestinationInput').val(),
                AvailableSeats: $('#dateOfDestinationInput').val(),
                OccupiedSeats: $('#totalSeatsInput').val(),
                Price: price,
                FlightStatus: $('#flightStatusSelect').val()
            };

            $.ajax({
                url: `/api/flights/${flightId}`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(updatedFlight),
                success: function () {
                    alert('Flight updated successfully!');
                    window.location.href = '/AdminFlights.html';
                },
                error: function (xhr, status, error) {
                    console.error('Error updating flight:', error);
                    alert('Failed to update flight. Please check console for details.');
                }
            });
        });
    </script>
</body>
</html>
