<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>AdminFlights</title>
</head>
<body>
    <h1>AdminFlights Page</h1>
    <table>
        <thead>
            <tr>
                <th>Id</th>
                <th>Airline</th>
                <th>Departure</th>
                <th>Destination</th>
                <th>Date of Departure</th>
                <th>Date of Destination</th>
                <th>Available Seats</th>
                <th>Occupied Seats</th>
                <th>Price</th>
                <th>Flight Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="flightTableBody">
            <!-- Table rows will be dynamically populated here -->
        </tbody>
    </table>

    <h1>Add New Flight</h1>
    <form id="addFlightForm">
        <label for="airlineSelect">Select Airline:</label>
        <select id="airlineSelect">
            <!-- Populate options dynamically from '/api/airlines' -->
        </select><br><br>
        <label for="departureInput">Departure:</label>
        <input type="text" id="departureInput" required><br><br>
        <label for="destinationInput">Destination:</label>
        <input type="text" id="destinationInput" required><br><br>
        <label for="dateOfDepartureInput">Date of Departure:</label>
        <input type="datetime-local" id="dateOfDepartureInput" required><br><br>
        <label for="dateOfDestinationInput">Date of Destination:</label>
        <input type="datetime-local" id="dateOfDestinationInput" required><br><br>
        <label for="priceInput">Price:</label>
        <input type="number" id="priceInput" min="1" step="any" required><br><br>
        <label for="totalSeatsInput">Number of seats: </label>
        <input type="number" id="totalSeatsInput" min="1" required><br><br>
        <button type="submit">Add Flight</button>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            fetchFlights();
            populateAirlines();
        });
        // Fetch flights from API and dynamically populate table
        function fetchFlights() {
            fetch('/api/flights')
                .then(response => response.json())
                .then(data => {
                    const flightTableBody = document.getElementById('flightTableBody');
                    flightTableBody.innerHTML = '';
                    data.forEach(flight => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${flight.Id}</td>
                            <td>${flight.Airline}</td>
                            <td>${flight.Departure}</td>
                            <td>${flight.Destination}</td>
                            <td>${flight.DateOfDeparture}</td>
                            <td>${flight.DateOfDestination}</td>
                            <td>${flight.AvailableSeats}</td>
                            <td>${flight.OccupiedSeats}</td>
                            <td>${flight.Price}</td>
                            <td>${flight.FlightStatus}</td>
                            <td>
                                <button onclick="editFlight(${flight.Id})">Edit</button>
                                <button onclick="deleteFlight(${flight.Id})">Delete</button>
                            </td>
                        `;
                        flightTableBody.appendChild(row);
                    });
                })
                .catch(error => console.error('Error fetching flights:', error));
        }
        function editFlight(id) {
            window.location.href = `/AdminEditFlight.html?Id=${id}`;
        }

        function populateAirlines() {
            fetch('/api/airlines')
                .then(response => response.json())
                .then(data => {
                    const airlineSelect = document.getElementById('airlineSelect');
                    data.forEach(airline => {
                        const option = document.createElement('option');
                        option.value = airline.Id;
                        option.textContent = airline.Name;
                        airlineSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching airlines:', error));
        }

        // Handle form submission
        document.getElementById('addFlightForm').addEventListener('submit', function (event) {
            event.preventDefault();

            var airlineSelect = document.getElementById('airlineSelect');
            var departureInput = document.getElementById('departureInput');
            var destinationInput = document.getElementById('destinationInput');
            var dateOfDepartureInput = document.getElementById('dateOfDepartureInput');
            var dateOfDestinationInput = document.getElementById('dateOfDestinationInput');
            var priceInput = document.getElementById('priceInput');
            var totalSeatsInput = document.getElementById('totalSeatsInput');

            if (!airlineSelect.value || !departureInput.value || !destinationInput.value ||
                !dateOfDepartureInput.value || !dateOfDestinationInput.value || !priceInput.value ||
                !totalSeatsInput.value) {
                alert("Please fill in all fields.");
                return;
            }

            var newFlight = {
                Airline: airlineSelect.value,
                Departure: departureInput.value,
                Destination: destinationInput.value,
                DateOfDeparture: dateOfDepartureInput.value,
                DateOfDestination: dateOfDestinationInput.value,
                Price: parseFloat(priceInput.value),
                FlightStatus: 'Active',
                AvailableSeats: parseInt(totalSeatsInput.value),
                OccupiedSeats: 0
            };

            fetch('/api/flights', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newFlight)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to add flight. Server responded with ' + response.status);
                    }
                    alert('Flight added successfully!');
                    fetchFlights();
                    document.getElementById('addFlightForm').reset();
                })
                .catch(error => {
                    console.error('Error adding flight:', error);
                    alert('Failed to add flight. Please check console for details.');
                });
        });

        let reservations = [];

        fetch('/api/reservations')
            .then(response => response.json())
            .then(data => {
                reservations = data;
                console.log('Reservations fetched:', reservations);
            })
            .catch(error => console.error('Error fetching reservations:', error));

        function deleteFlight(id) {
            fetch(`/api/flights/${id}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(reservations)
            })
                .then(response => {
                    if (response.ok) {
                        alert('Flight deleted successfully!');
                        // Optionally refresh the flight list or perform other actions
                        fetchFlights();
                    } else {
                        return response.json().then(error => {
                            throw new Error(error.message);
                        });
                    }
                })
                .catch(error => alert('Error deleting flight: ' + error.message));
        }

    </script>
</body>
</html>
