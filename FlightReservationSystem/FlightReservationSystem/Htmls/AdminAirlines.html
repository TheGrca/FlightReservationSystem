<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Airlines</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: 400px;
            margin-left: 35%;
            margin-top: 25px;
        }

        .filter-container {
            margin-top: 20px;
        }

            .filter-container label {
                display: block;
                margin-bottom: 8px;
                font-weight: bold;
            }

            .filter-container input[type="text"],
            .filter-container input[type="email"],
            .filter-container input[type="date"],
            .filter-container select {
                width: calc(100% - 20px);
                padding: 8px;
                margin-bottom: 15px;
                border: 1px solid #ccc;
                border-radius: 4px;
                box-sizing: border-box;
            }
    </style>
</head>
<body>
    <div id="navbar"></div>
    <h1>Edit Airlines</h1>

    <div style="display: flex; align-items: center; justify-content: center; gap: 20px;">
    <label for="filterName">Name:</label>
    <input type="text" id="filterName"><br>

    <label for="filterAddress">Address:</label>
    <input type="text" id="filterAddress"><br>

    <label for="filterContact">Contact:</label>
    <input type="text" id="filterContact"><br>

    <button id="filterButton">Filter</button>
        </div>
    <table id="airlinesTable">
        <thead>
            <tr>
                <th>Name</th>
                <th>Address</th>
                <th>Contact</th>
            </tr>
        </thead>
        <tbody>
           
        </tbody>
    </table>

    <div class="container">
        <h2>Add Airline</h2>
        <form id="addAirlineForm">
            <label for="name">Name:</label>
            <input type="text" id="name" required><br>

            <label for="address">Address:</label>
            <input type="text" id="address" required><br>

            <label for="contact">Contact:</label>
            <input type="text" id="contact" required><br>

            <button type="submit">Add Airline</button>
        </form>
    </div>

    <div class="container">
        <h2>Edit Airline</h2>
        <label for="editAirline">Select Airline:</label>
        <select id="editAirline">
            
        </select><br>

        <label for="editName">Name:</label>
        <input type="text" id="editName" required><br>

        <label for="editAddress">Address:</label>
        <input type="text" id="editAddress" required><br>

        <label for="editContact">Contact:</label>
        <input type="text" id="editContact" required><br>

        <button id="editAirlineBtn">Edit Airline</button>
    </div>

    <div class="container">
    <h2>Delete Airline</h2>
    <label for="deleteAirline">Select Airline:</label>
    <select id="deleteAirline">
        <!-- Options will be dynamically populated -->
    </select>

    <button id="deleteButton">Delete Airline</button>
    </div>

    <script>
        $(document).ready(function () {
            $("#navbar").load("navbar.html");
            
            function loadAirlines() {
                $.ajax({
                    type: "GET",
                    url: "/api/airlines",
                    success: function (response) {
                        var airlinesTable = $("#airlinesTable tbody");
                        airlinesTable.empty();

                        response.forEach(function (airline) {
                            airlinesTable.append(
                                `<tr data-id="${airline.Id}">
                                                        <td>${airline.Name}</td>
                                                        <td>${airline.Address}</td>
                                                        <td>${airline.Contact}</td>
                                                    </tr>`
                            );
                        });         
                        populateDropdowns();
                    },
                    error: function (xhr) {
                        console.error("Error fetching airlines:", xhr.statusText);
                    }
                });
            }

            loadAirlines();

            function populateDropdowns() {
                $.ajax({
                    type: "GET",
                    url: "/api/airlines",
                    success: function (response) {
                        var editAirlineSelect = $("#editAirline");
                        var deleteAirlineSelect = $("#deleteAirline");

                        editAirlineSelect.empty();
                        deleteAirlineSelect.empty();

                        response.forEach(function (airline) {
                            editAirlineSelect.append(`<option value="${airline.Id}">${airline.Name}</option>`);
                            deleteAirlineSelect.append(`<option value="${airline.Id}">${airline.Name}</option>`);
                        });

                        editAirlineSelect.trigger("change");
                    },
                    error: function (xhr) {
                        console.error("Error fetching airlines:", xhr.statusText);
                    }
                });
            }

            $("#filterButton").click(function () {
                var filterName = $("#filterName").val().toLowerCase();
                var filterAddress = $("#filterAddress").val().toLowerCase();
                var filterContact = $("#filterContact").val().toLowerCase();

                $("#airlinesTable tbody tr").each(function () {
                    var name = $(this).find("td:nth-child(1)").text().toLowerCase();
                    var address = $(this).find("td:nth-child(2)").text().toLowerCase();
                    var contact = $(this).find("td:nth-child(3)").text().toLowerCase();

                    var nameMatch = name.includes(filterName);
                    var addressMatch = address.includes(filterAddress);
                    var contactMatch = contact.includes(filterContact);

                    if (nameMatch && addressMatch && contactMatch) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            });

            $("#editAirline").change(function () {
                var airlineId = $(this).val();

                if (!airlineId) {
                    $("#editName").val("");
                    $("#editAddress").val("");
                    $("#editContact").val("");
                    return;
                }

                $.ajax({
                    type: "GET",
                    url: `/api/airlines/${airlineId}`,
                    success: function (airline) {
                        $("#editName").val(airline.Name);
                        $("#editAddress").val(airline.Address);
                        $("#editContact").val(airline.Contact);
                    },
                    error: function (xhr) {
                        console.error("Error fetching airline:", xhr.statusText);
                    }
                });
            });

            $(document).on("click", ".editBtn", function () {
                var airlineId = $(this).closest("tr").data("id");

                $.ajax({
                    type: "GET",
                    url: `/api/airlines/${airlineId}`,
                    success: function (airline) {
                        $("#editAirline").val(airline.Id); 
                        $("#editName").val(airline.Name);
                        $("#editAddress").val(airline.Address);
                        $("#editContact").val(airline.Contact);
                    },
                    error: function (xhr) {
                        console.error("Error fetching airline:", xhr.statusText);
                    }
                });
            });

            $("#addAirlineForm").submit(function (event) {
                event.preventDefault();

                
                var name = $("#name").val();
                var address = $("#address").val();
                var contact = $("#contact").val();

                if (!name || !address || !contact) {
                    alert("Please fill in all fields.");
                    return;
                }

                var newAirline = {
                    Name: name,
                    Address: address,
                    Contact: contact,
                    Flights: [], 
                    Reviews: []  
                };

                $.ajax({
                    type: "POST",
                    url: "/api/airlines",
                    contentType: "application/json",
                    data: JSON.stringify(newAirline),
                    success: function (response) {
                        alert("Airline added successfully!");
                        loadAirlines();
                        populateDropdowns();
                        $("#addAirlineForm")[0].reset();
                    },
                    error: function (xhr) {
                        console.error("Error adding airline:", xhr.statusText);
                    }
                });
            });


            $("#deleteButton").click(async function () {
                var airlineId = $("#deleteAirline").val();

                try {
                    let airlineResponse = await $.ajax({
                        type: "GET",
                        url: `/api/airlines/${airlineId}`
                    });

                    let airline = airlineResponse;
                    let activeFlights = [];

                    if (airline.Flights != null) {
                        for (let flightId of airline.Flights) {
                            let flightResponse = await $.ajax({
                                type: "GET",
                                url: `/api/flights/${flightId}`
                            });

                            if (flightResponse.FlightStatus === "Active") {
                                activeFlights.push(flightResponse);
                            }
                        }
                    }

                    if (activeFlights.length > 0) {
                        alert("Cannot delete the airline because it has active flights.");
                    } else {
                        await $.ajax({
                            type: "DELETE",
                            url: `/api/airlines/${airlineId}`
                        });

                        alert("Airline deleted successfully!");
                        loadAirlines();
                        populateDropdowns();
                    }
                } catch (xhr) {
                    console.error("Error:", xhr.statusText);
                }
            });

            $("#editAirlineBtn").click(function (event) {
                event.preventDefault();

                var name = $("#editName").val();
                var address = $("#editAddress").val();
                var contact = $("#editContact").val();

                if (!name || !address || !contact) {
                    alert("Please fill in all fields.");
                    return;
                }

                var airlineId = $("#editAirline").val();
                var updatedAirline = {
                    Id: airlineId,
                    Name: name,
                    Address: address,
                    Contact: contact,
                };

                $.ajax({
                    type: "PUT",
                    url: `/api/airlines/${airlineId}`,
                    contentType: "application/json",
                    data: JSON.stringify(updatedAirline),
                    success: function (response) {
                        alert("Airline updated successfully!");
                        loadAirlines(); 
                        populateDropdowns();
                    },
                    error: function (xhr) {
                        console.error("Error updating airline:", xhr.statusText);
                    }
                });
            });
        });
    </script>
</body>
</html>
