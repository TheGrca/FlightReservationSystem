<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title id="pageTitle">Airline Details</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            $("#navbar").load("navbar.html");

            var urlParams = new URLSearchParams(window.location.search);
            var airlineId = urlParams.get('id');

            if (!airlineId) {
                alert("Airline ID not found.");
                window.location.href = "Airlines.html";
            }

            $.ajax({
                url: "/api/airlines/" + airlineId,
                method: "GET",
                success: function (airline) {
                    if (airline) {
                        $("#pageTitle").text(airline.Name + " Details");
                        $("#airlineName").text(airline.Name);

                        var airlineDetailsRows = "";
                        airlineDetailsRows += "<tr><td>Id</td><td>" + airline.Id + "</td></tr>";
                        airlineDetailsRows += "<tr><td>Name</td><td>" + airline.Name + "</td></tr>";
                        airlineDetailsRows += "<tr><td>Address</td><td>" + airline.Address + "</td></tr>";
                        airlineDetailsRows += "<tr><td>Contact</td><td>" + airline.Contact + "</td></tr>";

                        var flightIds = airline.Flights;
                        $.ajax({
                            url: "/api/flights/byIds",
                            method: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(flightIds),
                            success: function (flights) {
                                var flightsRows = "<tr><td>Flights</td><td>";
                                if (flights.length > 0) {
                                    flights.forEach(function (flight) {
                                        flightsRows += "<p>" + formatFlightDetails(flight) + "</p>";
                                    });
                                } else {
                                    flightsRows += "No flights available";
                                }
                                flightsRows += "</td></tr>";
                                $("#airlineDetailsBody").html(airlineDetailsRows + flightsRows);
                            },
                            error: function (xhr, status, error) {
                                console.error("Error fetching flights:", error);
                                var errorRow = "<tr><td>Flights</td><td>Error fetching flights</td></tr>";
                                $("#airlineDetailsBody").html(airlineDetailsRows + errorRow);
                            }
                        });

                        
                        $.ajax({
                            url: "/api/reviews/airline/" + airlineId,
                            method: "GET",
                            success: function (reviews) {
                                if (reviews.length > 0) {
                                    var reviewsTableRows = "";
                                    reviews.forEach(function (review) {
                                        reviewsTableRows += "<tr>";
                                        reviewsTableRows += "<td>" + review.Reviewer.Name + "</td>";
                                        reviewsTableRows += "<td>" + review.Title + "</td>";
                                        reviewsTableRows += "<td>" + review.Content + "</td>";
                                        if (review.ImagePath) {
                                            var imageUrl = "/Images/" + review.ImagePath; 
                                            reviewsTableRows += "<td><img src='" + imageUrl + "' alt='Review Image' width='100'/></td>";
                                        } else {
                                            reviewsTableRows += "<td>No Image</td>";
                                        }
                                        reviewsTableRows += "</tr>";
                                    });
                                    $("#reviewsBody").html(reviewsTableRows);
                                } else {
                                    $("#reviewsBody").html("<tr><td colspan='4'>No reviews available</td></tr>");
                                }
                            },
                            error: function (xhr, status, error) {
                                console.error("Error fetching reviews:", error);
                                $("#reviewsBody").html("<tr><td colspan='4'>Error fetching reviews</td></tr>");
                            }
                        });

                    } else {
                        alert("Airline not found.");
                        window.location.href = "Airlines.html";
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error fetching airline details:", error);
                    alert("Error fetching airline details. Please try again later.");
                    window.location.href = "Airlines.html";
                }
            });

            function formatFlightDetails(flight) {
                return flight.Departure + " -> " + flight.Destination + " (" + new Date(flight.DateOfDeparture).toLocaleString() + ")";
            }
        });
    </script>
</head>
<body>
    <div id="navbar"></div>
    <h1 id="airlineName">Airline Details</h1>
    <table id="airlineDetailsTable">
        <thead>
            <tr>
                <th>Property</th>
                <th>Value</th>
            </tr>
        </thead>
        <tbody id="airlineDetailsBody">
            
        </tbody>
    </table>

    <h1>Reviews</h1>
    <table id="reviewsTable">
        <thead>
            <tr>
                <th>User Name</th>
                <th>Title</th>
                <th>Content</th>
                <th>Image</th>
            </tr>
        </thead>
        <tbody id="reviewsBody">
           
        </tbody>
    </table>
</body>
</html>
